sequenceDiagram
    participant Client as MCP Client
    participant Server as Gmail MCP Server
    participant EmailFetcher as Email Fetcher
    participant CategorizationEngine as Categorization Engine
    participant ImportanceAnalyzer as Importance Analyzer
    participant DateSizeAnalyzer as Date/Size Analyzer
    participant CacheManager as Cache Manager
    participant GmailAPI as Gmail API Client
    participant LocalCacheDB as Local Cache DB

    Client->>Server: Call tool: authenticate
    Server-->>Client: Authentication Success

    Client->>Server: Call tool: categorize_emails (force_refresh: true)
    Server->>CategorizationEngine: Request Email Categorization
    CategorizationEngine->>EmailFetcher: Fetch All Emails
    EmailFetcher->>GmailAPI: Request Emails (batch processing)
    GmailAPI-->>EmailFetcher: Email Data
    EmailFetcher-->>CategorizationEngine: Raw Email Data
    CategorizationEngine->>ImportanceAnalyzer: Analyze Importance
    CategorizationEngine->>DateSizeAnalyzer: Analyze Date and Size
    CategorizationEngine->>CacheManager: Store Categorized Email Metadata
    CacheManager->>LocalCacheDB: Persist Metadata
    LocalCacheDB-->>CacheManager: Metadata Stored
    CacheManager-->>CategorizationEngine: Categorization Complete
    CategorizationEngine-->>Server: Categorization Report (processed, categories)
    Server-->>Client: Categorization Success

    Client->>Server: Call tool: get_email_stats (group_by: "all")
    Server->>CategorizationEngine: Request Email Statistics
    CategorizationEngine->>LocalCacheDB: Retrieve Categorized Email Metadata
    LocalCacheDB-->>CategorizationEngine: Metadata
    CategorizationEngine-->>Server: Email Statistics (grouped by all)
    Server-->>Client: Statistics Success